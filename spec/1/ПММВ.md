# ПММВ
## Протокол взаимодействия в гетерогенном модульном мобильном роботе

Протокол межмодульного взаимодействия (ПММВ) - это протокол обмена данными в модульном мобильном роботе.

* Имя: 1/ПММВ
* Статус: черновик (draft)
* Редактор: Плетенев Павел Филиппович <<cpp.create@gmail.com>>.
* Соавторы: Андреев Виктор Павлович <andreevvipa@yandex.ru>>, Ким Валерий Леонидович <<top7733@gmail.com>>, Кирсанов Кирилл Борисович <<kkirsanov@gmail.com>>.


### Преамбула
Это открытая спецификация, она создаётся и управляется на основе [Консенсус-Ориентированной Системы Спецификации организации Digital Standards Organization](https://asmfreak.github.io/rfc_translations/digistan.org/1/%D0%9A%D0%9E%D0%A1%D0%A1/).

Термины "ДОЛЖНО", "ДОЛЖНА", "ДОЛЖНЫ", "ДОЛЖЕН", "ОБЯЗАТЕЛЬНЫЙ", "ОБЯЗАТЕЛЬНО" (MUST, REQUIRED, SHALL), "НЕ ДОЛЖЕН", НЕ ДОЛЖНА", "НЕ ДОЛЖНЫ" (MUST NOT, SHALL NOT), "РЕКОМЕНДОВАНО" (SHOULD, RECOMMENDED), "НЕ РЕКОМЕНДОВАНО" (SHOULD NOT, NOT RECOMMENDED), "МОГУТ", "МОЖЕТ" (MAY, OPTIONAL) в рамках этого документа ДОЛЖНЫ интерпретироваться в соответствии с RFC 2119[REFERENCES].

### Лицензия

Copyright (c) 2017 Редактор и Соавторы.

This Specification is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 3 of the License, or (at your option) any later version.

This Specification is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with this program; if not, see <http://www.gnu.org/licenses>.

### Модульный принцип
Данный документ использует модульный принцип построения мобильного робота. Более подробно он описан в [ANDREEV_ER-2016]. Далее приведены положения этого принципа:

* информационно-измерительная и управляющая система (ИИУС) робота ДОЛЖНА строится как локальная вычислительная сеть (LAN), узлами которой ДОЛЖНЫ являться модули;
* каждый модуль ДОЛЖЕН быть функционально завершённым электронным или мехатронным устройством со своей собственной ИИУС;
* каждый модуль ДОЛЖЕН предоставлять сетевой интерфейс соответствующий данному документу;
* при построении аппаратной части модулей ДОЛЖЕН использоваться принцип распределённого стабилизированного питания [описание?].

### Термины
Для специфицирования формата данных в документе используется следующая терминология:

"`число`"  - это целое или вещественное число.
"`строка`"  - это последовательность символов в кодировке UTF-8.
Именем "`объект`" называются число, строка, словарь-отображение и список.
"`словарь-отображение`" - хранит данные в виде списка `ключей`, которые ссылаются на некоторые `значения`.
"`ключ`" - это `строка`
"`значение`" представляет собой `объект`.
"`список`" содержит последовательность объектов.
В корне любой структуры ДОЛЖЕН находится "`корневой-объект`" - словарь-отоображение.
"`последовательность-байт`" - это последовательность байт произвольной длины.


Спецификация преобразования - это описание алгоритма, который переводит `корневой-объект` в `последовательность-байт` и `последовательность-байт` в `корневой-объект`.

Далее в документе в сочетании слов
  `ключ  "word"`
  символы в кавычках ДОЛЖНЫ интерпретироваться как строка, чувствительная к регистру.

При описании словарей-отображений используется следующее соглашение: все ОБЯЗАТЕЛЬНЫЕ ключи ДОЛЖНЫ присутствовать в описываемом словаре, а остальные МОГУТ присутствовать, если не описано иначе.

В некоторых спецификациях преобразования важна последовательность ключей в словарях-отображениях, которая не гарантируется в некоторых языках программирования. Поэтому после любого преобразования ОБЯЗАТЕЛЬНЫЕ ключи ДОЛЖНЫ следовать именно в том порядке, в каком они перечислены в данном документе.

Термин "сетевой интерфейс" в контексте этого документа определяется как один или несколько сокетов, реализующих спецификацию ZMTP/23[ZMTP/23], которые получают и/или предоставляют информацию. Сетевой интерфейс принимает и отправляет сообщения в виде последовательности байт, которые он преобразует в/из объект.

* "Синхронным" называется сокет, работающий по спецификации REP [ZMQREPREQ]. При этом он сначала получает запрос, затем посылает ответ.

* "Асинхронным" называется сокет, работающий по спецификации PUB [ZMQPUBSUB]. При этом он только отправляет сообщения, не получая ничего в ответ.



* Мнемоническое имя - это последовательность байт, которая может состоять из любых символов, закодированных с использованием UTF-8.

* Имя - это строка, содержащая ТОЛЬКО символы A-Z, a-z, 0-9, и символы запятой, точки и нижнего подчёркивания.

* Команда - это словарь-отображение, который содержит следующие ключи:
    * ОБЯЗАТЕЛЬНЫЙ ключ "action" - ДОЛЖЕН содержать мнемоническое имя или номер команды.
    * любые другие ключи кроме "action" с любыми значениями - аргументы команды.

* Команды передаются как запросы через синхронный сокет. Модуль ДОЛЖЕН дать ответ на команду как можно скорее.

* Результаты работы команд, которые нельзя вернуть сразу же ДОЛЖНЫ передаваться через асинхронный сокет.


### Сетевой интерфейс модуля
* Модуль ДОЛЖЕН иметь интерфейс для работы в сети Ethernet.
* Модуль ДОЛЖЕН предоставлять один или несколько сетевых интерфейсов для управления и/или получения показаний.
* Модуль ДОЛЖЕН иметь специальный сетевой интерфейс, называемый далее метаинтерфейсом модуля.

#### Метаинтерфейс модуля
* Метаинтерфейс модуля ДОЛЖЕН выполнять общие для всех модулей команды.

##### Общие для всех модулей команды
* Исходя из принципов модульности, каждый модуль должен выполнять следующие общие для всех модулей команды.
* На команду "ping" метаинтерфейс ДОЛЖЕН в ответ отправить словарь-отображение с ключом "status" и значением "ok". Эта команда используется для обнаружения модуля.
* На команду "metadata" метаинтерфейс ДОЛЖЕН в ответ отправить метаданные модуля, описываемые ниже.
* На команду "found_module" с аргументом "metadata" метаинтерфейс ДОЛЖЕН в ответ отправить словарь-отображение с ключом "status" и значением "ok". Эта команда означает, что подающим эту команду супервизором найден модуль c метаданными "metadata". При этом получивший команду модуль МОЖЕТ самостоятельно запросить у новонайденного модуля метаинформацию через сетевой протокол супервизора, описываемый ниже.
* На команду "shutdown" метаинтерфейс ДОЛЖЕН в ответ отправить словарь-отображение с ключом "status" и значением "ok" и ключом "estimated_time" со значением оценки времени выключения в секундах. После получения этой команды метаинтерфейс модуля ДОЛЖЕН начать процедуру "легального" выключения модуля.
* На команду "known_modules" метаинтерфейс ДОЛЖЕН в ответ отправить словарь-отображение с ключом "addresses" и значением списка известных ему IP-адресов других модулей. Метаинтерфейс МОЖЕТ вести такой список.

##### Метаданные модуля
* Метаданные модуля ДОЛЖНЫ быть представлены в виде словаря-отображения строка - значение и ДОЛЖНЫ отображать все функции модуля.
* Словарь метаданных модуля ДОЛЖЕН быть преобразован в формат JSON для предоставления через метаинтерфейс модуля в виде последовательности байт.
* Словарь метаданных модуля :
    * ОБЯЗАТЕЛЬНЫЙ ключ "name" содержит строку имени модуля;
    * ключ "description" - строка с описанием модуля на естественном языке;
    * ОБЯЗАТЕЛЬНЫЙ ключ "address" - строка состоящую из 4 целых чисел  в интервале [0, 255] разделённых символом точки ".", которая определяет IP-адрес модуля;
    * ключ "parameters" - формальное описание настраиваемых параметров модуля и ДОЛЖЕН содержать одно из следующих значений:
        * строка "none" - интерфейс не имеет выходных данных;
        * список словарей-отображений свойств величины:
            * ОБЯЗАТЕЛЬНЫЙ ключ "name" - строка имени параметра;
            * ОБЯЗАТЕЛЬНЫЙ ключ "unit" - строка мнемонического имени единицы измерения параметра;
            * ОБЯЗАТЕЛЬНЫЙ ключ "default" - умолчательное значение параметра;
            * ключ "type" - тип параметра;
            * ключ "description" - описание параметра на естественном языке;
    * ОБЯЗАТЕЛЬНЫЙ ключ "interfaces" - словарь-отображение мнемонического имени интерфейса на словарь его свойств:
       * ОБЯЗАТЕЛЬНЫЙ ключ "sockets" - непустой словарь-отображение целочисленного номера порта, записанного в виде строки, в тип сокета в виде строки, который ДОЛЖЕН принимать следующие значения:
           * "sync" - сокет считается "синхронным";
           * "async" - сокет считается "асинхронным" - он работает по спецификации PUB [ZMQPUBSUB];
           * "asyncudp" - сокет считается "асинхронным", но работает по протоколу UDP;
       * ОБЯЗАТЕЛЬНЫЙ ключ "serialization"  ДОЛЖЕН содержать способ преобразования данных и команд в строки и ДОЛЖЕН принимать одно из следующих значений:
           * "json" - означает, что используется спецификация преобразования JSON [JSONSPEC]
           * "bson" - означает, что используется спецификация преобразования BSON [BSONSPEC]
           * "msgp" - означает, что используется спецификация преобразования MSGPACK [MSGPACKSPEC]
       * ключ "input" ДОЛЖЕН являться формальным описанием команд, которые можно послать модулю, и ДОЛЖЕН содержать одно из следующих значений:
           * строка "none" - интерфейс не имеет входных команд, если ключ "input" не задан - это занчение принимается по умолчанию;
           * список словарей-отображений свойств команды (номер команды получается из её индекса):
               * ОБЯЗАТЕЛЬНЫЙ ключ "name" ДОЛЖЕН содержать строку - мнемоническое имя команды;
               * ключ "args" - свойства аргумента и ДОЛЖЕН содержать одно из следующих значений:
                   * строка "none" - команда не имеет аргументов;
                   * список словарей-отображений свойств значения:
                       * ОБЯЗАТЕЛЬНЫЙ ключ "name" ДОЛЖЕН содержать строку имени аргумента.
                       * ОБЯЗАТЕЛЬНЫЙ ключ "unit" ДОЛЖЕН содержать строку мнемонического имени единицы измерения аргумента.
                       * ключ "type" - тип аргумента
                       * ключ "description" - описание аргумента на естественном языке;
               * ключ "returns" - возвращаемые значения команды и ДОЛЖЕН содержать одно из следующих значений:
                   * строка "none" - команда возращает пустой словарь;
                   * список словарей-отображений свойств значения:
                       * ОБЯЗАТЕЛЬНЫЙ ключ "name" ДОЛЖЕН содержать строку имени аргумента.
                       * ОБЯЗАТЕЛЬНЫЙ ключ "unit" ДОЛЖЕН содержать строку мнемонического имени единицы измерения аргумента.
                       * ключ "type" - тип аргумента
                       * ключ "description" - описание аргумента на естественном языке;
               * ключ "description" МОЖЕТ содержать описание команды на естественном языке;
       * ОБЯЗАТЕЛЬНЫЙ ключ "output" - формальное описание наборов величин, которые может послать модуль, и ДОЛЖЕН содержать одно из следующих значений:
           * строка "none" - интерфейс не имеет выходных данных;
           * список словарей-отображений свойств величины:
               * ОБЯЗАТЕЛЬНЫЙ ключ "name" ДОЛЖЕН содержать строку - мнемоническое имя команды;
               * ключ "args" - свойства аргумента и ДОЛЖЕН содержать одно из следующих значений:
                   * ОБЯЗАТЕЛЬНЫЙ ключ "name" ДОЛЖЕН содержать строку имени аргумента.
                   * ОБЯЗАТЕЛЬНЫЙ ключ "unit" ДОЛЖЕН содержать строку мнемонического имени единицы измерения аргумента.
                   * ключ "type" - тип аргумента
                   * ключ "description" - описание аргумента на естественном языке;
       * ключ "description" МОЖЕТ содержать описание сетевого интерфейса на естественном языке;
* В словаре-отображении метаданных модуля в словаре-отображении свойств интерфейса ДОЛЖЕН присутсвовать хотя бы один из ключей "input" или "output".
* Словарь метаданных модуля МОЖЕТ содержать другие ключи. Такие ключи ДОЛЖНЫ начинаться с символов "x-".


### Сетевой протокол работы супервизора
* Супервизор ДОЛЖЕН использовать метаинтерфейс модуля для получения метаданных модуля.
* Супервизор ДОЛЖЕН явно закрыть подключение к сетевому интерфейсу сразу после получения метаданных.
* Супервизор ДОЛЖЕН использовать метаданные модуля для выбора типа сокета и метода преобразования.
* Супервизор МОЖЕТ подавать команды через "синхронный" сокет сетевого интерфейса, если таковой определён для данного интерфейса в метаданных модуля.
* Супервизор МОЖЕТ подписаться на получение данных от датчиков модуля через "асинхронный" сокет сетевого интерфейса, если таковой определён для данного интерфейса в метаданных модуля.


### Нормативные ссылки.
[ABNFRFC] RFC 5234 — Расширенная спецификация синтаксиса Бэкуса-Наура (ABNF) https://rfc2.ru/5234.rfc/print
[ANDREEV_ER-2016]  Андреев В.П., Подураев Ю.В. Функционально-модульный принцип построения гетерогенных мобильных роботов // Экстремальная робототехника. Труды международной научно-технической конференции. – Санкт-Петербург, 2016.
[BSONSPEC] BSON http://bsonspec.org/spec.html
[JSONSPEC] ECMA-404 http://www.ecma-international.org/publications/files/ECMA-ST/ECMA-404.pdf
[MSGPACKSPEC] https://github.com/msgpack/msgpack/blob/master/spec.md
[REFERENCES] 	Bradner, S., “Key words for use in RFCs to Indicate Requirement Levels”, BCP 14, RFC 2119, March 1997. URL: https://tools.ietf.org/html/rfc2119
[ZMTP/23] iMatic Corporation & Contributors, ZeroMQ Message Transport Protocol https://rfc.zeromq.org/spec:23/ZMTP/
[ZMQREPREQ] iMatic Corporation & Contributors, ZeroMQ Request-Reply https://rfc.zeromq.org/spec:28/REQREP/
[ZMQPUBSUB] iMatic Corporation & Contributors, ZeroMQ Publish-Subscribe https://rfc.zeromq.org/spec:29/PUBSUB
